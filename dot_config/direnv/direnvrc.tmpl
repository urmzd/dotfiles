{{- if .use_nix }}
# Central direnv configuration — managed by chezmoi
# Loads nix-direnv and wraps use_flake to auto-inherit global tools

# Load nix-direnv (provides use_flake / use_nix)
if ! has nix_direnv_version || ! nix_direnv_version 3.0.4; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.4/direnvrc" "sha256-DzlYZ33mWF/Gs8DDeyjr8mnVmQGx7ASYqA5WlxwvBG4="
fi

# Save the original use_flake from nix-direnv
_original_use_flake=$(declare -f use_flake)
eval "_nix_direnv_use_flake${_original_use_flake#use_flake}"

# Wrapped use_flake: inherits global tools via source_up_if_exists
use_flake() {
  # Capture PATH before anything runs (includes direnv's baseline)
  local _pre_path="$PATH"

  # Chain parent .envrc files (e.g. ~/.envrc for global nix tools).
  # From ~/ this is a no-op (no parent .envrc above ~/) — no recursion.
  source_up_if_exists

  # Capture PATH after parent environments have been loaded
  local _parent_path="$PATH"

  # Run the real nix-direnv use_flake
  _nix_direnv_use_flake "$@"

  # Safety-net: merge any parent PATH entries that got dropped.
  # nix print-dev-env normally preserves them, but shellHook or other
  # mechanisms may truncate PATH.
  local _merged="$PATH"
  local IFS=':'
  for _p in $_parent_path; do
    case ":${_merged}:" in
      *:"$_p":*) ;;
      *) _merged="${_merged}:${_p}" ;;
    esac
  done
  export PATH="$_merged"
}
{{- end }}
