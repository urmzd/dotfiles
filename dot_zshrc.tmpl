#!/usr/bin/env zsh

{{- if .use_nix }}
# Nix configuration - Load FIRST before any shell customization
if [ -e '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh' ]; then
  . '/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh'
fi

# Enable direnv for Nix integration - Load BEFORE oh-my-zsh
{{ if lookPath "direnv" -}}
# Silence direnv output to prevent environment variable spam
export DIRENV_LOG_FORMAT=""
eval "$(direnv hook $(basename "$SHELL"))"
{{- end }}
{{- end }}

# Enable Powerlevel10k instant prompt AFTER environment is set
# Disable instant prompt completely when using direnv or tmux to prevent conflicts
if [[ -z "$TMUX" && -z "$DIRENV_DIR" && -z "$IN_NIX_SHELL" && -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

export ZSH=$HOME/.oh-my-zsh
ZSH_THEME="powerlevel10k/powerlevel10k"

plugins=(git zsh-syntax-highlighting zsh-completions)

# Load Homebrew-installed completion scripts (e.g., just) before compinit
if command -v brew >/dev/null 2>&1; then
  HOMEBREW_PREFIX="${HOMEBREW_PREFIX:-$(brew --prefix 2>/dev/null)}"
  if [[ -d "$HOMEBREW_PREFIX/share/zsh/site-functions" ]]; then
    fpath=("$HOMEBREW_PREFIX/share/zsh/site-functions" $fpath)
  fi
fi

fpath+=${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions/src

# Initialize completions before loading oh-my-zsh
autoload -U compinit && compinit

# Load oh-my-zsh AFTER environment is properly set
source "$ZSH/oh-my-zsh.sh"

# Enable colors for ls - Cyberdream theme
# Load AFTER oh-my-zsh to prevent it from being overridden
{{- if .is_macos }}
# macOS: use BSD ls with -G for colors, or GNU ls if available from Nix
# Cyberdream colors: blue (#5ea1ff), green (#5eff6c), cyan (#5ef1ff), magenta (#bd5eff)
if command -v gdircolors >/dev/null 2>&1; then
  eval "$(gdircolors -b)"
  # Customize LS_COLORS with Cyberdream palette (256-color codes)
  # di=38;5;75 (blue dirs), ex=38;5;83 (green executables), ln=38;5;87 (cyan symlinks)
  export LS_COLORS="di=38;5;75:ex=38;5;83:ln=38;5;87:or=38;5;141:mi=38;5;203:*.archive=38;5;141:*.tar=38;5;141:*.tgz=38;5;141:*.arc=38;5;141:*.arj=38;5;141:*.taz=38;5;141:*.lha=38;5;141:*.lz4=38;5;141:*.lzh=38;5;141:*.lzma=38;5;141:*.tlz=38;5;141:*.txz=38;5;141:*.tzo=38;5;141:*.t7z=38;5;141:*.zip=38;5;141:*.z=38;5;141:*.dz=38;5;141:*.gz=38;5;141:*.lrz=38;5;141:*.lz=38;5;141:*.lzop=38;5;141:*.xz=38;5;141:*.zst=38;5;141:*.zstd=38;5;141:*.bz2=38;5;141:*.bz=38;5;141:*.tbz=38;5;141:*.tbz2=38;5;141:*.tz=38;5;141:*.deb=38;5;141:*.rpm=38;5;141:*.jar=38;5;141:*.war=38;5;141:*.ear=38;5;141:*.rar=38;5;141:*.aces=38;5;141:*.7z=38;5;141:*.ace=38;5;141:*.apk=38;5;141:*.cpio=38;5;141:*.iso=38;5;141:*.cab=38;5;141:*.img=38;5;141:*.msi=38;5;141"
  alias ls='gls --color=auto'
elif ls --color=auto &>/dev/null 2>&1; then
  # GNU ls available (from Nix)
  if command -v dircolors >/dev/null 2>&1; then
    eval "$(dircolors -b)"
  fi
  # Customize LS_COLORS with Cyberdream palette
  export LS_COLORS="di=38;5;75:ex=38;5;83:ln=38;5;87:or=38;5;141:mi=38;5;203:*.archive=38;5;141:*.tar=38;5;141:*.tgz=38;5;141:*.arc=38;5;141:*.arj=38;5;141:*.taz=38;5;141:*.lha=38;5;141:*.lz4=38;5;141:*.lzh=38;5;141:*.lzma=38;5;141:*.tlz=38;5;141:*.txz=38;5;141:*.tzo=38;5;141:*.t7z=38;5;141:*.zip=38;5;141:*.z=38;5;141:*.dz=38;5;141:*.gz=38;5;141:*.lrz=38;5;141:*.lz=38;5;141:*.lzop=38;5;141:*.xz=38;5;141:*.zst=38;5;141:*.zstd=38;5;141:*.bz2=38;5;141:*.bz=38;5;141:*.tbz=38;5;141:*.tbz2=38;5;141:*.tz=38;5;141:*.deb=38;5;141:*.rpm=38;5;141:*.jar=38;5;141:*.war=38;5;141:*.ear=38;5;141:*.rar=38;5;141:*.aces=38;5;141:*.7z=38;5;141:*.ace=38;5;141:*.apk=38;5;141:*.cpio=38;5;141:*.iso=38;5;141:*.cab=38;5;141:*.img=38;5;141:*.msi=38;5;141"
  alias ls='ls --color=auto'
else
  # BSD ls (default macOS) - use LSCOLORS format
  alias ls='ls -G'
  export CLICOLOR=1
  # Cyberdream BSD equivalent: directories=blue (B), executables=green (x)
  export LSCOLORS=BxGxfxfxCxCxBxBxBxBxEx
fi
{{- else }}
# Linux: use GNU coreutils
if command -v dircolors >/dev/null 2>&1; then
  eval "$(dircolors -b)"
fi
alias ls='ls --color=auto'
{{- end }}

export EDITOR='nvim'

alias vi="nvim"
alias vim="nvim"

# Cloud authentication aliases
# GCP: User and application-default login
alias gcpsso="gcloud auth login && gcloud auth application-default login"

# Snowflake: SSO/browser-based authentication
# Uses SNOWFLAKE_ACCOUNT and SNOWFLAKE_USER from direnv (.envrc.local)
alias snowsso='snowsql --authenticator externalbrowser -a "$SNOWFLAKE_ACCOUNT" -u "$SNOWFLAKE_USER"'

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# FZF integration
{{ if lookPath "fzf" -}}
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
# Set up fzf key bindings and fuzzy completion
source <(fzf --zsh)
{{- end }}

# Python pipx completions
{{ if lookPath "pipx" -}}
eval "$(register-python-argcomplete --shell zsh pipx)"
{{- end }}

# ============================================================================
# CLI Tool Completions (runtime eval with lookPath guards)
# ============================================================================

# DevOps & Cloud
{{ if lookPath "gh" -}}
eval "$(gh completion -s zsh)"
{{- end }}
{{ if lookPath "docker" -}}
eval "$(docker completion zsh)"
{{- end }}
{{ if lookPath "kubectl" -}}
eval "$(kubectl completion zsh)"
{{- end }}
{{ if lookPath "helm" -}}
eval "$(helm completion zsh)"
{{- end }}
{{ if lookPath "k9s" -}}
eval "$(k9s completion zsh)"
{{- end }}
{{ if lookPath "colima" -}}
eval "$(colima completion zsh)"
{{- end }}
{{ if lookPath "aws_completer" -}}
autoload -Uz bashcompinit && bashcompinit
complete -C "$(which aws_completer)" aws
{{- end }}

# Development Tools
{{ if lookPath "chezmoi" -}}
eval "$(chezmoi completion zsh)"
{{- end }}
{{ if lookPath "just" -}}
eval "$(just --completions zsh)"
{{- end }}
{{ if lookPath "uv" -}}
eval "$(uv generate-shell-completion zsh)"
{{- end }}
{{ if lookPath "ruff" -}}
eval "$(ruff generate-shell-completion zsh)"
{{- end }}
{{ if lookPath "deno" -}}
eval "$(deno completions zsh)"
{{- end }}
{{ if lookPath "rustup" -}}
eval "$(rustup completions zsh)"
eval "$(rustup completions zsh cargo)"
{{- end }}
{{ if lookPath "npm" -}}
eval "$(npm completion)"
{{- end }}
{{ if lookPath "golangci-lint" -}}
eval "$(golangci-lint completion zsh)"
{{- end }}

# Load local environment if exists
[ -f "$HOME/.local/bin/env" ] && . "$HOME/.local/bin/env"

# Source all function files from ~/.zsh/functions
if [[ -d "$HOME/.zsh/functions" ]]; then
  for func_file in "$HOME/.zsh/functions"/*.zsh(N); do
    source "$func_file"
  done
fi
